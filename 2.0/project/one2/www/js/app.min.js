var app={initialize:function(){this.bindEvents()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,false)},onDeviceReady:function(){app.receivedEvent("deviceready")},receivedEvent:function(a){console.log("收到事件: "+a);app.bbuistart()},lang:"zh-CN",bbuistart:function(){if(webworksreadyFired){return}webworksreadyFired=true;var a;if(darkColoring){a={controlsDark:true,listsDark:true}}else{a={controlsDark:false,listsDark:false,coloredTitleBar:true}}a.onscreenready=function(c,d){app.lang=blackberry.system.language;i18n.process(c,app.lang);console.log("载入页面: "+d);if(darkColoring){var b=c.querySelector("[data-bb-type=screen]");if(b){b.style["background-color"]=darkScreenColor}}if(d==="settings"){window.removeEventListener("orientationchange",onRotate);loadSettings(c,d)}if(d==="menu"){}};a.ondomready=function(b,d,c){if(d==="showCalendar"){loadAvailableMagsAsync(b);Hammer(gg(b,"cal")).on("swiperight",function(e){if(e.gesture.distance>200){bb.popScreen()}})}if(d==="menu"){window.removeEventListener("orientationchange",onRotate);loadContent(b,d);Hammer(gg(b,"wrap")).on("swiperight",function(e){if(e.gesture.distance>200){goNext()}}).on("swipeleft",function(e){if(e.gesture.distance>200){goPrev()}});shortcut.remove("T");shortcut.remove("B");shortcut.remove("0");shortcut.remove("P");shortcut.remove("N");shortcut.remove("space");shortcut.add("T",function(){g("wrap").scrollTo(0,0)});shortcut.add("B",function(){g("wrap").scrollTo(g("ask").offsetTop+g("ask").scrollHeight,0)});shortcut.add("0",function(){g("wrap").scrollTo(g("home").parentNode.parentNode.scrollTop-700,0)});shortcut.add("P",function(){goPrev()});shortcut.add("N",function(){goNext()});shortcut.add("space",function(){g("wrap").scrollTo(g("home").parentNode.parentNode.scrollTop+700,0)})}if(d==="cached"){window.removeEventListener("orientationchange",onRotate);loadCachedMagsAsync(b);Hammer(gg(b,"cca")).on("swiperight",function(){bb.popScreen()})}};bb.init(a);if(darkColoring){document.body.style["background-color"]=darkScreenColor;document.body.style.color="#E6E6E6"}navigator.splashscreen.hide();bb.pushScreen("main.html","menu")}};function goNext(){var b=new Date(currentdisplaydate);b.setDate(b.getDate()+1);var a=new Date();if(a.format("yyyy-MM-dd")<b.format("yyyy-MM-dd")){Toast.regular(trans("没有之后的内容"),1000);return}else{currentdisplaydate=b.format("yyyy-MM-dd");g("wrap").scrollTo(0,0);loadContent(document,"")}}function goPrev(){var b=new Date(currentdisplaydate);b.setDate(b.getDate()-1);var a=new Date();a.setDate(a.getDate()-10);if(a.format("yyyy-MM-dd")>=b.format("yyyy-MM-dd")){Toast.regular(trans("没有之前的内容"),1000);return}else{currentdisplaydate=b.format("yyyy-MM-dd");g("wrap").scrollTo(0,0);loadContent(document,"")}}function loadSettings(e,a){var h=e.getElementById("drop");var k=localStorage.getItem("fontsize");if(k==null){h.options[2].setAttribute("selected","true")}else{for(var f=0;f<5;f++){if(h.options[f].value==k){h.options[f].setAttribute("selected","true");break}}}var b=e.getElementById("langdrop");var j=localStorage.getItem("lang");if(j==null){b.options[0].setAttribute("selected","true")}else{for(var f=0;f<2;f++){if(b.options[f].value==j){b.options[f].setAttribute("selected","true");break}}}var c=e.getElementById("themeToggle");var d=localStorage.getItem("theme");if("true"===d){usingDarkTheme=true;c.setAttribute("data-bb-checked","true")}else{usingDarkTheme=false;c.setAttribute("data-bb-checked","false")}bb.refresh()}function saveSettings(a){if(a.checked){console.log(">>使用黑色主题.");localStorage.setItem("theme","true")}else{console.log(">>使用亮色主题.");localStorage.setItem("theme","false")}}function refreshTheme(){var a=localStorage.getItem("theme");if(a===usingDarkTheme){return}else{window.location.reload()}}function onRotate(){if(window.innerWidth===720){g("newList").style.margin="0px"}else{if(window.innerWidth===768){g("newList").style.margin="0px 20px"}else{if(window.innerWidth===1280){g("newList").style.margin="0px 85px"}}}}var listenerAdded=false;var token;function loadAvailableMagsAsync(a){gg(a,"spinner-4").show();if(!listenerAdded){token=window.addEventListener("orientationchange",onRotate,false)}findCachedMagsAsync(function(b){findAvailableMagsAsync(function(j){var h;if(j){h=removeDuplicatesInPlace(b.concat(j)).sort(function(n,m){if(n.strdate>m.strdate){return -1}else{if(n.strdate===m.strdate){return 0}else{return 1}}})}else{h=b}var l=gg(a,"newList");l.style.display="none";for(var e=0;e<h.length;e++){console.log(h[e]);var k=h[e]["strdate"].concat("");var f=document.createElement("div");f.className="item";var d=document.createElement("div");d.className="label";d.innerHTML=k+" "+h[e]["status"];var c=new Image();c.id="i"+k;c.src="img/welcome.png";getTitleImg(c,k);f.appendChild(c);f.appendChild(d);f.setAttribute("strdate",k);f.onclick=function(){currentdisplaydate=this.getAttribute("strdate");sessionStorage.setItem("show",currentdisplaydate);oneloaded=false;homeloaded=false;qloaded=false;bb.pushScreen("main.html","menu")};l.appendChild(f)}gg(a,"spinner-4").hide();l.style.display="block";onRotate()})})}function getTitleImg(b,a){one.getHomePageAsync(a,function(c){var e=c.hpEntity;if(e){cache.get(e.strOriginalImgUrl,a,function(d){console.log("设置图片："+d);b.src=d})}})}function loadCachedMagsAsync(a){setTimeout(findCachedMagsAsync(function(f){f=f.sort(function(j,h){if(j.strdate>h.strdate){return -1}else{if(j.strdate===h.strdate){return 0}else{return 1}}});var d=gg(a,"cachedmags");d.clear();var b=[];var e;for(var c=0;c<f.length;c++){e=document.createElement("div");e.setAttribute("data-bb-type","item");e.setAttribute("data-bb-title",f[c]["strdate"]);e.setAttribute("data-mrk-date",f[c]["strdate"]);e.innerHTML=f[c]["status"];e.onbtnclick=function(){deleteSelected()};b.push(e)}d.refresh(b)}),0)}function deleteSelected(){var a=g("cachedmags").selected;console.log("[ONE]删除已缓存的内容 : "+a.getAttribute("data-mrk-date"));var c=a.getAttribute("data-mrk-date");try{localStorage.removeItem(c.concat("title"));removeByDate(c)}catch(b){console.log(b)}loadCachedMagsAsync(document)}function findCachedMagsAsync(a){setTimeout(function(){var f=[];var c;var e=/^\d{4}-\d{2}-\d{2}title$/i;for(var d=0;d<localStorage.length;d++){c=localStorage.key(d);if(e.test(c)){var b={};b.title=localStorage.getItem(c);b.strdate=c.substr(0,10);b.status="已缓存";f.push(b)}}a(f)},0)}function findAvailableMagsAsync(f){var a=[];for(var b=0;b<10;b++){var e=new Date();e.setDate(e.getDate()-b);var c={};c.title="";c.strdate=e.format("yyyy-MM-dd");c.status="可下载";a.push(c)}f(a)}function displaySelected(){var a=g("historyList").selected;console.log(a.getAttribute("data-mrk-date")+" 被点击，准备显示。");currentdisplaydate=a.getAttribute("data-mrk-date");sessionStorage.setItem("show",currentdisplaydate);oneloaded=false;homeloaded=false;qloaded=false;bb.pushScreen("main.html","menu")}var removeDuplicatesInPlace=function(a){var c,b,d;for(c=a.length-1;c>=0;c--){d=a[c];for(b=c-1;b>=0;b--){if(d.strdate===a[b]["strdate"]){if(c!==b){a.splice(c,1)}}}}return a};function getJSON(a,d){try{var b=community.curl.get(a);if(d){d(JSON.parse(b))}return JSON.parse(b)}catch(c){console.log("获取数据出错，将返回NULL并删除下载错误的文件。");return null}}function loadContent(a,c){if(!currentdisplaydate){if(sessionStorage.getItem("show")){currentdisplaydate=sessionStorage.getItem("show")}else{var b=new Date();currentdisplaydate=b.format("yyyy-MM-dd");sessionStorage.setItem("show",currentdisplaydate)}}cleanContent(a);loadAll(a,currentdisplaydate)}function cleanContent(a){gg(a,"home-img").style.display="none";gg(a,"home-vol").innerHTML="";gg(a,"home-pbdate").innerHTML="";gg(a,"home-title").innerHTML="";gg(a,"home-img-by").innerHTML="";gg(a,"home-content").innerHTML="";gg(a,"content").style.display="none";gg(a,"ask").style.display="none";gg(a,"c-title").innerHTML="";gg(a,"c-author").innerHTML="";gg(a,"c-author-intro").innerHTML="";gg(a,"c-brief").innerHTML="";gg(a,"c-content").innerHTML="";gg(a,"q-title").innerHTML="";gg(a,"q-content").innerHTML="";gg(a,"a-title").innerHTML="";gg(a,"a-content").innerHTML=""}function g(a){return gg(document,a)}function gg(a,b){return a.getElementById(b)}var displaylang=app.lang;function loadAll(a,c){var b=localStorage.getItem("lang");if(b==null||b==="zh-CN"){displaylang="zh-CN"}else{displaylang="zh-TW"}loadhome(a,c);loadOne(a,c);loadQuestion(a,c)}function trans(a){if(displaylang==="zh-TW"){return Traditionalized(a)}else{return Simplized(a)}}function loadhome(a,b){gg(a,"spinner-1").show();one.getHomePageAsync(b,function(c){if(d===null){Toast.regular(trans("载入首页数据失败，请检查网络连接后重试。"),1000);gg(a,"home-img").style.display="block";gg(a,"spinner-1").hide();return}var d=c.hpEntity;localStorage.setItem(b+"title",d.strHpTitle);gg(a,"home-title").innerHTML=b.substr(0,7);gg(a,"home-pbdate").innerHTML=b.substr(8,2);gg(a,"home-vol").innerHTML=d.strHpTitle;gg(a,"home-img-by").innerHTML=trans(d.strAuthor.replace(/&/g," "));gg(a,"home-content").innerHTML=trans(d.strContent);gg(a,"home-content").style.fontSize=localStorage.getItem("fontsize");imgurl=d.strOriginalImgUrl;console.log("主页已载入。");homeloaded=true;if(window.innerHeight<800){gg(a,"ab").hide()}cache.get(imgurl,currentdisplaydate,function(e){console.log("设置图片："+e);g("home-img").src=e;g("home-img").style.display="block";gg(a,"spinner-1").hide()})})}var homeloaded,oneloaded,qloaded,imgurl;function removeChildNodes(b){var a=b.childNodes;for(i=0;i<a.length;i++){b.removeChild(a[i])}}function loadOne(b,a){one.getOneContentInfoAsync(a,function(e){if(e===null){Toast.regular(trans("载入文章内容失败，请检查网络连接后重试。"),1000);return}var d=e.contentEntity;gg(b,"c-brief").innerHTML=trans(d.sGW);gg(b,"c-title").innerHTML=trans(d.strContTitle);gg(b,"c-author-intro").innerHTML=trans(d.strContAuthorIntroduce);gg(b,"c-author").innerHTML=trans(d.strContAuthor);gg(b,"c-content").innerHTML=trans("<p>"+d.strContent.replace(/<br>/g,"</p><p>")+"</p>");gg(b,"c-content").style.fontSize=localStorage.getItem("fontsize");console.log("内容已载入。");gg(b,"content").style.display="block";oneloaded=true})}function loadQuestion(b,a){one.getOneQuestionInfoAsync(a,function(c){if(c===null){Toast.regular(trans("载入文章内容失败，请检查网络连接后重试。"),1000);return}var d=c.questionAdEntity;gg(b,"q-title").innerHTML=trans(d.strQuestionTitle);gg(b,"q-content").innerHTML=trans(d.strQuestionContent);gg(b,"q-content").style.fontSize=localStorage.getItem("fontsize");gg(b,"a-title").innerHTML=trans(d.strAnswerTitle);gg(b,"a-content").innerHTML=trans(d.strAnswerContent);gg(b,"a-content").style.fontSize=localStorage.getItem("fontsize");console.log("问题已载入。");gg(b,"ask").style.display="block";qloaded=true})}Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length===1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b};function showTab(a){if(a==="home"){goTo("home")}else{if(a==="content"){goTo("content")}else{if(a==="question"){goTo("ask")}}}}function goTo(b){var a=g(b).offsetTop;g("wrap").scrollTo(a,0)}var currentdisplaydate;function clearCache(){var b=localStorage.getItem("theme");var a=localStorage.getItem("fontsize");localStorage.clear();localStorage.setItem("theme",b);localStorage.setItem("fontsize",a);Toast.regular(trans("缓存已清除"),1000);loadAvailableMags(document,"reload")}function saveFont(b){var a=b.value;localStorage.setItem("fontsize",a)}function saveLang(a){var b=a.value;localStorage.setItem("lang",b)}var lastpos=0;var showActionBar=true;function tabswitcher(){var a=g("home").parentNode.parentNode;if(a.scrollTop<g("content").offsetTop){bb.actionBar.highlightAction(g("a1"))}else{if(a.scrollTop<g("ask").offsetTop){bb.actionBar.highlightAction(g("a2"))}else{bb.actionBar.highlightAction(g("a3"))}}if(window.innerHeight<800){if(a.scrollTop<5){showActionBar=false;setTimeout(function(){if(!showActionBar){g("ab").hide()}},333)}else{if(a.scrollTop>lastpos){showActionBar=false;setTimeout(function(){if(!showActionBar){g("ab").hide()}},333)}else{showActionBar=true;setTimeout(function(){if(showActionBar){g("ab").show()}},333)}}}else{showActionBar=true;setTimeout(function(){if(showActionBar){g("ab").show()}},333)}lastpos=a.scrollTop}function shareText(){var a=getSelText();if(a){Invoke.shareText(a)}else{Toast.regular(trans("您未选择要分享的内容"),1000)}}function getSelText(){if(window.getSelection){return window.getSelection()}else{if(document.getSelection){return document.getSelection()}else{if(document.selection){return document.selection.createRange().text}else{return""}}}};